var rf = (function(){
  return window.requestAnimationFrame       ||
      window.webkitRequestAnimationFrame ||
      window.mozRequestAnimationFrame    ||
      window.oRequestAnimationFrame      ||
      window.msRequestAnimationFrame     ||
      function(cb){
          window.setTimeout(cb, 1000 / 60);
      };
})();

var lastTime;
var now;
var dt = 0;
var fps = 60;
var slowMo = 1;
var step = 1 / fps;
var sStep = slowMo * step;


var gameAsset;
var Renderer;
var Sound;
var level = 0;

var map = {
	size:{
		tile:{width:32, height:32},
		iso:{width:40, height:32},
		screen:{width:25, height:19}			
	},
	colliders:{
		hit:[8,9],
		over:[4,5,6,7]
	},
	levels:[
		{
			dim:{width:116, height:143},data:"0,116|1,116|0,116|1,116|0,116|1,116|0,116|1,116|0,116|1,116|0,9|8,98|0,9|1,9|9|1,9|9|1,82|9|1,3|9|1,9|0,9|8|0,9|8|0,82|8|0,3|8|0,9|1,9|9|1,9|9|1,82|9|1,3|9|1,9|0,9|8|0,9|8|0,82|8|0,3|8|0,9|1,9|9|1,9|9|1,82|9|1,3|9|1,9|0,9|8|0,9|8|0,82|8|0,3|8|0,9|1,9|9|1,9|9|1,82|9|1,3|9|1,9|0,9|8|0,9|8|0,82|8|0,3|8|0,9|1,9|9|1,9|9|1,82|9|1,3|9|1,9|0,9|8|0,9|8|0,82|8|0,3|8|0,9|1,9|9|1,9|9|1,82|9|1,3|9|1,9|0,9|8|0,9|8|0,82|8|0,3|8|0,9|1,9|9|1,9|9|1,82|9|1,3|9|1,9|0,9|8|0,9|8|0,82|8|0,3|8|0,9|1,9|9|1,9|9|1,82|9|1,3|9|1,9|0,9|8|0,9|8|0,82|8|0,3|8|0,9|1,9|9|1,9|9|1,82|9|1,3|9|1,9|0,9|8|0,9|8|0,82|8|0,3|8|0,9|1,9|9|1,9|9|1,82|9|1,3|9|1,9|0,9|9|0,9|9|0,58|7|0,23|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8|1,9|8|1,19|7|1,62|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,50|7|0,17|7|0,13|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,3|7|0,29|7|0,48|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8|1,9|8|1,55|7|1,26|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,13|4,8|12,3|4,2|0,56|9|0,3|9|0,9|1,9|8|1,9|8|1,13|4,8|13,3|4,5|1,53|8|1,3|8|1,9|0,9|9|0,3|7|0,5|9|0,9|4,12|12,3|4,4|0,54|9|0,3|9|0,9|1,9|8|1,9|8|1,9|5|4,11|13,3|4,10|1,48|8|1,3|8|1,9|0,9|9|0,9|9|0,12|4,9|12,3|4,13|0,11|4,4|12,3|4,15|0,12|9|0,3|9|0,9|1,9|8|1,9|8|1,12|5|4,8|13,3|4,28|13,3|4,17|1,10|8|1,3|8|1,9|0,9|9|0,9|9|0,35|5|4,16|12,3|4,16|0,11|9|0,3|9|0,9|1,9|8|1,9|8|1,44|5|4,7|13,3|4,18|1,9|8|1,3|8|1,9|0,9|9|0,9|9|0,59|5|4,14|0,8|9|0,3|9|0,9|1,9|8|1,9|8|1,58|14|1,23|8|1,3|8|1,9|0,9|9|0,9|9|0,47|15|0,34|9|0,3|9|0,9|1,9|8|1,9|8|1,42|14|1,9|14|1,29|8|1,3|8|1,9|0,9|9|0,9|9|0,61|15|0,20|9|0,3|9|0,9|1,9|8|1,9|8|1,48|14|1,6|14|1,26|8|1,3|8|1,9|0,9|9|0,9|9|0,5|7|6,2|0,43|15|0,30|9|0,3|9|0,9|1,9|8|1,9|8|1,6|7|6,5|1,16|7|6,3|1,13|14|1,36|8|1,3|8|1,9|0,9|9|0,9|9|0,7|7|6,5|0,16|7|6,2|0,48|6,2|9|0,3|9|0,9|1,9|8|1,9|8|1,8|7|6,5|1,33|14|1,4|14|1,26|7|6,2|8|1,3|8|1,9|0,9|9|0,9|9|0,57|15|0,22|7|6|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,47|15|0,34|9|0,3|9|0,9|1,9|8|1,9|8|1,55|14|1,26|8|1,3|8|1,9|0,9|9|0,9|9|0,50|7|0,31|9|0,3|9|0,9|1,9|8|1,9|8|1,37|14|1,44|8|1,3|8|1,9|0,9|9|0,9|9|0,38|3,2|15|0,41|9|0,3|9|0,9|1,9|8|1,9|8|1,37|14|2,2|14|1,41|8|1,3|8|1,9|0,9|9|0,9|9|0,37|15|3,2|15|0,41|9|0,3|9|0,9|1,9|8|1,9|8|1,37|14|2,2|1,42|8|1,3|8|1,9|0,9|9|0,9|9|0,37|15|3,2|15|0,41|9|0,3|9|0,9|1,9|8|1,9|8|1,38|2,2|14|1,41|8|1,3|8|1,9|0,9|9|0,9|9|0,37|15|3,2|15|0,41|9|0,3|9|0,9|1,9|8|1,9|8|1,37|14|2,2|14|1,41|8|1,3|8|1,9|0,9|9|0,9|9|0,14|3,2|0,22|3,2|0,22|3,2|0,18|9|0,3|9|0,9|1,9|8|1,9|8|1,14|2,2|1,21|14|2,2|1,22|2,2|1,18|8|1,3|8|1,9|0,9|9|0,9|9|0,14|3,2|0,21|15|3,2|15|0,21|3,2|0,18|9|0,3|9|0,9|1,9|8|1,9|8|1,14|2,2|1,22|2,2|14|1,21|2,2|1,18|8|1,3|8|1,9|0,9|9|0,9|9|0,14|3,2|0,22|3,2|0,22|3,2|0,18|9|0,3|9|0,9|1,9|8|1,9|8|1,14|2,2|1,21|14|2,2|1,22|2,2|1,18|8|1,3|8|1,9|0,9|9|0,9|9|0,14|3,2|0,22|3,2|15|0,21|3,2|0,18|9|0,3|9|0,9|1,9|8|1,9|8|1,14|2,2|1,22|2,2|1,22|2,2|1,18|8|1,3|8|1,9|0,9|9|0,9|9|0,14|3,2|0,22|3,2|0,22|3,2|0,18|9|0,3|9|0,9|1,9|8|1,7|16,2|8|16,2|10,2|16,10|10,2|16,22|10,2|16,22|10,2|16,6|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16|10|8|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|10,2|8|10,21|16|10,47|16|1,12|8|1,3|8|1,9|0,9|9|0,7|10,2|9|10,21|16|10,47|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16|10|8|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16,2|8|16,2|10,2|16,10|10,2|16,10|10,2|16,10|10,2|16,10|10,2|16,10|10,2|16,6|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16|10|8|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,23|16|10,11|16|10,11|16|10,12|0,12|9|0,3|9|0,9|1,9|8|1,7|10,2|8|10,9|16|10,60|1,12|8|1,3|8|1,9|0,9|9|0,7|10,2|9|10,9|16|10,11|16|10,47|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16|10|8|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16,2|8|16,2|10,2|16,10|10,3|16,8|10,3|16,10|10,3|16,9|10,2|16,10|10,2|16,6|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16|10|8|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|10,2|8|10,9|16|10,11|16|10,47|16|1,12|8|1,3|8|1,9|0,9|9|0,7|10,2|9|10,9|16|10,11|16|10,47|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16|10|8|10,9|16|10,11|16|10,11|16|10,11|16|10,11|16|10,11|16|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|10,3|11,4|10,4|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16,2|8|16,2|10,2|16,10|10,2|16,10|10,2|16,10|11,2|16,10|10,2|16,10|10,2|16,6|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|11,11|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16|10|8|10,9|16|10,11|16|10,11|16|11,11|16|10,11|16|10,11|16|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|11,11|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16|10|8|10,9|16|10,11|16|10,11|16|11,11|16|10,23|16|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,21|16|10,11|16|11,11|16|10,23|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16|10|8|10,9|16|10,11|16|10,11|16|11,11|16|10,11|16|10,11|16|1,12|8|1,3|8|1,9|0,9|9|0,7|16|10|9|10,9|16|10,11|16|10,11|16|11,11|16|10,11|16|10,11|16|0,12|9|0,3|9|0,9|1,9|8|1,7|16|10|8|10,9|16|10,11|16|10,11|16|11,11|16|10,11|16|10,11|16|1,12|8|1,3|8|1,9|0,9|9|0,7|16,2|9|16,70|0,12|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8|1,9|8|1,82|8|1,3|8|1,9|0,9|9|0,9|9|0,82|9|0,3|9|0,9|1,9|8,98|1,9|0,116|1,116|0,116|1,116|0,116|1,116|0,116|1,116|0,116"
			,spawn:{	
				plr:{x:59,y:124},
				wall:[],
				tree:[],
				sign:[{x:42,y:59},
					{x:72,y:60},
					{x:65,y:68},
					{x:59,y:74},
					{x:60,y:94},
					{x:42,y:103},
					{x:60,y:118},
					]
			}	
		}
	]
};

/*****************************/
function Start(canvasBody)
{	
	// Create the canvas
	var canvas = document.createElement("canvas");
	if(canvas.getContext)
	{
		var ctx = canvas.getContext("2d");
		canvas.width = (map.size.screen.width * map.size.tile.width);
		canvas.height = (map.size.screen.height * map.size.tile.height);

		var b = document.getElementById(canvasBody);
    	b.appendChild(canvas);

		Renderer = new Rendering(ctx, {w:canvas.width, h:canvas.height}, 
			{x1:32,x2:32, y1:32,y2:96});

		Sound = new TinySound();
		init();
	}
}

function init()
{  
  var now = timestamp();	
	lastTime = now;

	gameAsset = new Game(map, level);

	FixedLoop();  
}

function SlowMo(mo){
	sStep = mo * step;
}

function FixedLoop(){
	if(Input.IsSingle('Escape') ) {
		gameAsset = new Game(map, level);
	}

	now = timestamp();
	dt = dt + Math.min(1, (now - lastTime) / 1000);
	while (dt > sStep) {
	  dt = dt - sStep;
	  update(step);
	}

	render();
				
	lastTime = now;
	rf(FixedLoop);
}

function timestamp() {
	var wp = window.performance;
	return wp && wp.now ? wp.now() : new Date().getTime();
}

// Update game objects
function update(dt) {
	gameAsset.Update(dt);
};

function render() {
	gameAsset.Render();
};

onkeydown = function(e)
{
    Input.Pressed(e, true);
};

onkeyup = function(e)  {
    Input.Pressed(e, false);
    Input.Released(e, true);
};

onblur = function(e)  {
    Input.pressedKeys = {};
};

window.onload = function() {
	Start("canvasBody");
}
