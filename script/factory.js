var Fac = [];
var ISO = 0.95;
var C = {
    pal:{
        white:13+48,
        black:14,
        title:40,
        gameover:15,
        pickup:15+16
    },
    col:{
        man:16,
        hat:17,    
        shadow:18,
        tree:19,
        rock:20,
        wall:21,
        sign:22,
        items:23,
        splash:24
    },   
    ass:{
        null:0,
        player:1,
        pickup:6,
        ptext:7
    },
    act:{
        up:0,
        dn:1,
        lt:2,
        rt:3,
        splat:4,
        splash:5,
        fall:6,
        dead:7
    },
    sound:{
        hop1:0,
        hop2:1,
        fall:2,
        splash:3,
        collect:4
    }
}

var MODE = {
    title:0,
    start:1,
    ready:2,
    game:3,    
    level:4,
    deathInfo:5,
    postInfo:6,
    over:9
}

var COLS = [
    [9+48],[9+32], 
    [13+16],[13+32], 
    [0+32],[0+32,0+16], 
    [11+32],[11+32,11+16], 
    [9+32],[9+48], 
    [13+48, 13+32], [6+48, 6+32],
    [11],[11+48],
    [],[],//spare
    [//16
        1+48,1+32,1+16,1,
        12+48,12+32,11+32,11+16,
        13+48,13+32
    ],
    [//17 hat
        14+48,14+32,14+16,14
    ],
    [15+48],//18 shadow
    [//tree
        9+48,9+32,9+16,9, 11,11+16
    ],
    [
        //20 rock??
    ],
    [ //21
        6+48,6+32,6+16,6, 14,13+32
    ],
    [//22
        8+48,8+32,8+16,8, 14,13+32
    ],
    [//23
        8+48,8+32,8+16,8, 14,13+32
    ],
    [//24 splash
        1+48,1+32,1+16
    ]
];
//           0      1       2     3    4       5       6      7      8      9     10     11     12     13     14     15
//           blu1  blu2   purp         pink    red    orng   yell          gr2    tq?    brn    flesh  whit   blck   spec
var PAL =[  "#134","#124","#214","#414","#413","#412","#421","#441","#341","#5a3","#144","#632","#953","#666","#000","#505",
            "#38a","#34a","#53a","#93a","#a38","#a34","#a53","#a93","#8a3","#5b3","#3a9","#742","#c74","#999","#222","#ff3",
            "#6be","#67e","#96e","#d6e","#e6b","#e67","#e96","#ed6","#be6","#5c3","#6ed","#851","#f95","#ccc","#333","#000",
            "#cef","#ccf","#dcf","#fcf","#fce","#fcc","#fdc","#ffc","#dfc","#5d3","#cff","#a61","#fb8","#fff","#555","#555"
];
   
var ST = [
"YOU ARE WORKING LATE AGAIN.|YOU START TO FEEL SLEEPY AND YOU FALL|ASLEEP AT YOUR DESK PLAYING MINESWEEPER.",
"YOU AWAKEN IN A STRANGE PLACE."
];

var OV=[
    "THERE WAS NO WAY OF KNOWING THAT|THE GROUND BENEATH YOU WAS SO|UNSTABLE AND YOU FELL TO YOUR",
    "DEATH"
];
var ON=[
    "BLAH ",
    "COFFEE MACHINE BROKEN.+ITS A MYSTERY SAYS DAN",
    "OFFICE NINJA STRIKES+AGAIN",
    "EARTHQUAKE IN BLETCHLEY+YESTERDAY. IT COULD BE+FELT AS FAR AWAY AS BATH+SAYS WITNESS",
    "ROAD CHAOS IN BLETCHLEY+SHEEP BLAMED",
    "PASSER BY HIT BY IPAD+FALLING FROM WINDOW.+THE IPAD WAS UNHARMED"
];

var assets ={   
    hero:{
        bodyH:[2,[8,11,0,-8,11,0,-8,11,-16,8,11,-16],3,[8,-4,0,8,11,0,8,11,-16,8,-4,-16],1,[16,16,-8,-16,16,-8,-16,16,-24,16,16,-24],3,[16,-16,-8,16,16,-8,16,16,-24,16,-16,-24],8,[16,16,-14,-16,16,-14,-16,16,-24,16,16,-24],9,[16,-16,-13,16,16,-14,16,16,-24,16,-16,-24],4,[16,16,-24,-16,16,-24,-16,16,-40,16,16,-40],5,[16,-16,-24,16,16,-24,16,16,-40,16,-16,-40],6,[-16,-16,-40,16,-16,-40,16,16,-40,-16,16,-40],9,[5,22,-6,-2,22,-6,-2,22,-21,5,22,-21],9,[5,16,-6,5,22,-6,5,22,-21,5,16,-21],8,[-2,16,-21,5,16,-21,5,22,-21,-2,22,-21]],
        bodyV:[
            2,[8,11,0,-8,11,0,-8,11,-16,8,11,-16],
            3,[8,-4,0,8,11,0,8,11,-16,8,-4,-16],
            9,[-16,4,-6,-21,4,-6,-21,4,-21,-16,4,-21],
            9,[-20,-4,-6,-20,4,-6,-20,4,-21,-20,-4,-21],
            8,[-21,-4,-21,-16,-4,-21,-16,4,-21,-21,4,-21],
            1,[16,16,-8,-16,16,-8,-16,16,-24,16,16,-24],
            3,[16,-16,-8,16,16,-8,16,16,-24,16,-16,-24],
            8,[16,16,-14,-16,16,-14,-16,16,-24,16,16,-24],
            9,[16,-16,-13,16,16,-14,16,16,-24,16,-16,-24],
            4,[16,16,-24,-16,16,-24,-16,16,-40,16,16,-40],
            5,[16,-16,-24,16,16,-24,16,16,-40,16,-16,-40],
            6,[-16,-16,-40,16,-16,-40,16,16,-40,-16,16,-40],
            9,[21,4,-6,16,4,-6,16,4,-21,21,4,-21],
            9,[21,-4,-6,21,4,-6,21,4,-21,21,-4,-21],
            8,[16,-4,-21,21,-4,-21,21,4,-21,16,4,-21]
            ],
        up:[6,[16,16,-27,-16,16,-27,-16,16,-40,16,16,-40],7,[16,-2,-27,16,16,-27,16,17,-40,16,-16,-40,16,-16,-34,16,-2,-33]
        ],
        down:[2,[-3,16,-33,-9,16,-33,-9,16,-36,-3,16,-36],2,[10,16,-33,4,16,-33,4,16,-36,10,16,-36],2,[15,16,-26,-15,16,-26,-15,16,-29,15,16,-29],7,[16,-2,-28,16,-16,-28,16,-16,-40,16,16,-40,16,16,-34,16,-1,-34]
        ],
        left:[7,[2,16,-28,16,16,-28,16,16,-40,-16,16,-40,-16,16,-34,2,16,-34],7,[16,-16,-28,16,16,-28,16,16,-40,16,-16,-40]
        ],
        right:[7,[-2,16,-28,-16,16,-28,-16,16,-40,16,16,-40,16,16,-34,-2,16,-34],7,[16,-16,-35,16,16,-35,16,16,-40,16,-16,-40],3,[16,-14,-26,16,14,-26,16,14,-28,16,-14,-28],3, [16,5,-31,16,11,-31,16,11,-33,16,5,-33],3,[16,-11,-31,16,-6,-31,16,-5,-33,16,-11,-33]
        ]
    },
    tree1:[4,[8,8,0,-8,8,0,-8,8,-32,8,8,-32],5,[8,-8,0,8,8,0,8,8,-32,8,-8,-32],2,[16,16,-32,-16,16,-32,-16,16,-66,16,16,-66],3,[16,-16,-32,16,16,-32,16,16,-66,16,-16,-66],0,[-16,-16,-66,16,-16,-66,16,16,-66,-16,16,-66]
    ],
    tree2:[4,[8,8,0,-8,8,0,-8,8,-32,8,8,-32],5,[8,-8,0,8,8,0,8,8,-32,8,-8,-32],2,[16,16,-27,-16,16,-27,-16,16,-38,16,16,-38],3,[16,-16,-28,16,16,-28,16,16,-38,16,-16,-38],0,[-16,-16,-38,16,-16,-38,16,16,-38,-16,16,-38],3,[8,-8,-38,8,8,-38,8,8,-50,8,-8,-50],2,[8,8,-38,-8,8,-38,-8,8,-50,8,8,-50],1,[-8,-8,-50,8,-8,-50,8,8,-50,-8,8,-50]
    ],    
    hat:[0,[-16,-16,0, 16,-16,0, 16,16,0, -16,16,0],
        1,[-10,-10,-16, 10,-10,-16, 10,10,-16, -10,10,-16],
        3,[10,-10,0, 10,10,0, 10,10,-16, 10,-10,-16],
        2,[10,10,0, -10,10,0, -10,10,-16, 10,10,-16]
    ],
    square:[0,[-16,-16,-16, 16,-16,-16, 16,16,-16, -16,16,-16],
            2,[16,-16,0, 16,16,0, 16,16,-16, 16,-16,-16],
            1,[16,16,0, -16,16,0, -16,16,-16, 16,16,-16]
    ],
    wall16:[1,[-16,-16,-16,16,-16,-16,16,16,-16,-16,16,-16],2,[16,16,0,-16,16,0,-16,16,-16,16,16,-16],3,[3,16,0,-16,16,0,-16,16,-6,3,16,-6],3,[16,16,-8,-3,16,-8,-3,16,-14,16,16,-14],3,[16,16,0,5,16,0,5,16,-6,16,16,-6],3,[-5,16,-8,-16,16,-8,-16,16,-14,-5,16,-14]],
    wall32:[1,[-16,-16,-32,16,-16,-32,16,16,-32,-16,16,-32],2,[16,16,0,-16,16,0,-16,16,-32,16,16,-32],3,[3,16,0,-16,16,0,-16,16,-6,3,16,-6],3,[16,16,-8,-3,16,-8,-3,16,-14,16,16,-14],3,[16,16,0,5,16,0,5,16,-6,16,16,-6],3,[16,16,-16,5,16,-16,5,16,-22,16,16,-22],3,[-5,16,-8,-16,16,-8,-16,16,-14,-5,16,-14],3,[-5,16,-24,-16,16,-24,-16,16,-30,-5,16,-30]],
    wall:[1,[-16,-16,-40,16,-16,-40,16,16,-40,-16,16,-40],2,[16,16,0,-16,16,0,-16,16,-40,16,16,-40],3,[3,16,0,-16,16,0,-16,16,-6,3,16,-6],3,[16,16,-8,-3,16,-8,-3,16,-14,16,16,-14],3,[3,16,-16,-16,16,-16,-16,16,-22,3,16,-22],3,[16,16,-24,-3,16,-24,-3,16,-30,16,16,-30],3,[3,16,-32,-16,16,-32,-16,16,-38,3,16,-38],3,[16,16,0,5,16,0,5,16,-6,16,16,-6],3,[16,16,-16,5,16,-16,5,16,-22,16,16,-22],3,[16,16,-32,5,16,-32,5,16,-38,16,16,-38],3,[-5,16,-8,-16,16,-8,-16,16,-14,-5,16,-14],3,[-5,16,-24,-16,16,-24,-16,16,-30,-5,16,-30]],
    rect:[2,[32,16,0,-32,16,0,-32,16,-16,32,16,-16],3,[32,-16,0,32,16,0,32,16,-16,32,-16,-16],1,[-32,-16,-16,32,-16,-16,32,16,-16,-32,16,-16]],    
    tile:[
        0,[-16,-16,0, 16,-16,0, 16,16,0, -16,16,0]
    ],
    tile1:[0,[-16,-16,0,16,-16,0,16,16,0,-16,16,0],1,[-15,-15,0,15,-15,0,15,15,0,-15,15,0]],
    tile2:[0,[-16,-16,0,16,-16,0,16,16,0,-16,16,0],1,[-11,16,0,-16,16,0,-16,-16,0]],
    lives:[5,[-8,-22,8,-22,8,-8,-8,-8],
        2,[-8,-8,8,-8,8,8,-8,8],
        1,[-5,8,5,8,5,16,-5,16]
    ],
    levels:[1,[-16,2,16,2,16,16,-16,16],
        1,[-11,-10,10,-10,10,2,-11,2]
    ]
};

var SOUNDS = [
    [1.02,,739,.03,,0,1,1.95,,,54,.02,.01,,,,,.42,.02],//hop1
    [,,277,,.01,.09,,.49,-8.9,-0.9,,,,,,,,.41,.06],//hop2
    [2,0,261.6256,,.08,.23,,1.17,,,,,,.4,,,.09,.26,.19],//fall        
    [2,0,261.6256,,.08,.23,,1.17,,,,,,.4,,,.09,.26,.19],//splash
    [2.77,,59,.01,.01,.01,3,1.93,,,5,.05,,,84,,.36,,.01]//collect
];

var FONT = {    
    'A': [
        [, 1, 0],
        [1, , 1],
        [1, 1, 1],
        [1, , 1],
        [1, , 1]
    ],
    'B': [
        [1, 1, 0],
        [1, , 1],
        [1, 1, 1],
        [1, , 1],
        [1, 1,0]
    ],
    'C': [
        [1, 1, 1],
        [1,0,0],
        [1,0,0],
        [1,0,0],
        [1, 1, 1]
    ],
    'D': [
        [1, 1,0],
        [1, , 1],
        [1, , 1],
        [1, , 1],
        [1, 1,0]
    ],
    'E': [
        [1, 1, 1],
        [1,0,0],
        [1, 1, 1],
        [1,0,0],
        [1, 1, 1]
    ],
    'F': [
        [1, 1, 1],
        [1,0,0],
        [1, 1,1],
        [1,0,0],
        [1,0,0]
    ],
    'G': [
        [, 1, 1,0],
        [1,0,0,0],
        [1, , 1, 1],
        [1, , , 1],
        [, 1, 1,0]
    ],
    'H': [
        [1, , 1],
        [1, , 1],
        [1, 1, 1],
        [1, , 1],
        [1, , 1]
    ],
    'I': [
        [1, 1, 1],
        [, 1,0],
        [, 1,0],
        [, 1,0],
        [1, 1, 1]
    ],
    'J': [
        [1, 1, 1],
        [, , 1],
        [, , 1],
        [1, , 1],
        [1, 1, 1]
    ],
    'K': [
        [1, , , 1],
        [1, , 1,0],
        [1, 1,0,0],
        [1, , 1,0],
        [1, , , 1]
    ],
    'L': [
        [1,0,0],
        [1,0,0],
        [1,0,0],
        [1,0,0],
        [1, 1, 1]
    ],
    'M': [
        [1,1,1,1],
        [1,0,1,1],
        [1,0,1,1],
        [1,0,0,1],
        [1,0,0,1]
    ],
    'N': [
        [1, , , 1],
        [1, 1, , 1],
        [1, , 1, 1],
        [1, , , 1],
        [1, , , 1]
    ],
    'O': [
        [1, 1, 1],
        [1, , 1],
        [1, , 1],
        [1, , 1],
        [1, 1, 1]
    ],
    'P': [
        [1, 1, 1],
        [1, , 1],
        [1, 1, 1],
        [1,0,0],
        [1,0,0]
    ],
    'Q': [
        [0, 1, 1,0],
        [1, , , 1],
        [1, , , 1],
        [1, , 1, 1],
        [1, 1, 1, 1]
    ],
    'R': [
        [1, 1,0],
        [1, , 1],
        [1, , 1],
        [1, 1,0],
        [1, , 1]
    ],
    'S': [
        [1, 1, 1],
        [1,0,0],
        [1, 1, 1],
        [, , 1],
        [1, 1, 1]
    ],
    'T': [
        [1, 1, 1],
        [, 1,0],
        [, 1,0],
        [, 1,0],
        [, 1,0]
    ],
    'U': [
        [1, , 1],
        [1, , 1],
        [1, , 1],
        [1, , 1],
        [1, 1, 1]
    ],
    'V': [
        [1, , 1],
        [1, , 1],
        [1, , 1],
        [1, , 1],
        [0, 1, 0]
    ],
    'W': [
        [1, , , 1],
        [1, , , 1],
        [1, , , 1],
        [1, , 1, 1],
        [1, 1, 1,1]
    ],
    'X': [
        [1,0,1],
        [1,0,1],
        [0,1,0],
        [1,0,1],
        [1,0,1]
    ],
    'Y': [
        [1, , 1],
        [1, , 1],
        [, 1,0],
        [, 1,0],
        [, 1,0]
    ],
    'Z': [
        [1, 1, 1],
        [, , 1],
        [, 1,0],
        [1,0,0],
        [1, 1, 1]
    ],
    '0': [
        [1, 1, 1],
        [1, , 1],
        [1, , 1],
        [1, , 1],
        [1, 1, 1]
    ],
    '1': [
        [, 1,0],
        [, 1,0],
        [, 1,0],
        [, 1,0],
        [, 1,0]
    ],
    '2': [
        [1,1,1],
        [0,0,1],
        [1,1,1],
        [1,0,0],
        [1,1,1]
    ],
    '3':[
        [1,1,1],
        [0,0,1],
        [1,1,1],
        [0,0,1],
        [1,1,1]
    ],
    '4':[
        [1,0,1],
        [1,0,1],
        [1,1,1],
        [0,0,1],
        [0,0,1]
    ],
    '5':[
        [1,1,1],
        [1,0,0],
        [1,1,1],
        [0,0,1],
        [1,1,1]
    ],
    '6':[
        [1,1,1],
        [1,0,0],
        [1,1,1],
        [1,0,1],
        [1,1,1]
    ],
    '7':[
        [1,1,1],
        [0,0,1],
        [0,0,1],
        [0,0,1],
        [0,0,1]
    ],
    '8':[
        [1,1,1],
        [1,0,1],
        [1,1,1],
        [1,0,1],
        [1,1,1]
    ],
    '9':[
        [1,1,1],
        [1,0,1],
        [1,1,1],
        [0,0,1],
        [1,1,1]
    ],
    '[': [
        [,1,1],
        [,1,],
        [,1,],
        [,1,],
        [,1,1]
    ],
    ']': [
        [1,1,],
        [,1,],
        [,1,],
        [,1,],
        [1,1,]
    ],
    ' ': [
        [, ,],
        [, ,],
        [, ,],
        [, ,],
        [, ,]
    ],
    '?': [
        [1,1,1],
        [1,0,1],
        [0,1,1],
        [0,1,0],
        [0,1,0]
    ],
    '!': [
        [0,1,0],
        [0,1,0],
        [0,1,0],
        [0,0,0],
        [0,1,0]
    ],
    '.': [
        [, ,],
        [, ,],
        [, ,],
        [, ,],
        [,1,]
    ],
    'Â£':
    [
        [0,1,1],
        [0,1,],
        [1,1,1],
        [0,1,0],
        [1,1,1]
    ],
    '|':[]
};

